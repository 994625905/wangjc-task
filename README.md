# wangjc-task
零散定时任务的规范处理，手动控制业务代码的执行
# wangjc-task.或许能帮你规范可控的管理应用定时任务
- （真实场景下的应用接入，可以更加精细化的设计代码，这只是个模型实例）

------------
- 我们在很多地方都需要用到各种各样的定时任务来批量处理数据，但是大多数采用@Scheduled注解的方式来设置的，在应用启动后，无法进行操作，这种操作包括手动的调用或者手动终止/激活
> （例如，同步远程接口数据，某次同步失败，需要复盘，那么只能手动调改代码来进行，诸如此来的局限性还有很多）
- 在github上也有很多成熟完整的案例来专门管理定时任务，我大约看了一下，特别棒。但架构体系有点庞大，如果任务量在10个以内的话，强行引入会显得很冗余，而且也没必要浪费资源，为此，咱们避重就轻，可以手动写一套简单的架构模型，可直接接入。

## 1.架构的设计
| 模块名称  | 作用  |
| ------------ | ------------ |
| wangjc-task-base  | 基类的封装，泛型的约束，常量，异常，结果集，工具类…………  |
|  wangjc-task-core |  业务代码层，操作数据库 |
| wangjc-task-web-autologin  | web层的单点登录  |
|  wangjc-task-web-timer | web层的任务模块  |
| 备注说明  | 除timer外，很多都是从项目中复制过来的，其实timer也一样，但即使是copy，也是之前自己全部手写的  |
- （这里把它单独抽成一个应用来发布）

- ### timer的底层包分类

| 包名称  | 存放作用  |
| ------------ | ------------ |
| config  | 数据源配置，freemarket配置，web配置，线程池配置  |
| core  | 定时任务的核心业务代码，每个任务对应一个core类，统一用@Component声明  |
| filter  | 拦截器  |
| help  | 协助类，这里只放置了登录状态的判定  |
| interceptors  |  web拦截器，SQL拦截器 |
| schedule  | 定时任务的设置代码，每个定时对应一个schedule，采用@Scheduled设置的定时类名用@Async("wangjcTimerAsyncServiceExecutor")声明多线程异步；实现SchedulingConfigurer的定时则不需要，它本就是新创建一个子线程来执行任务…………下文详解  |
| web  | web层管理定时任务。msg：新增，删除，修改，终止，启动，hand：手动触发  |

## 2.定时任务的管理

- ##### 1.创建类继承ThreadPoolTaskExecutor，重写方法。用于更好的管理和监测线程情况，假如需要相关线程的信息的话，可直接在子类中操作；
- ##### 2.配置线程池
- #####3.为了能在web层管理任务，需要将每个任务的相关数据在创建时期录入到数据库中，所以需要在页面中提交一个新增的表单；
- #####4.在wangjc-task-web-timer模块的core包下创建对应的业务类，编写核心业务代码，标注任务唯一标识常量，用于验证任务状态和记录日志时使用；
- #####5.在wangjc-task-web-timer模块的schedule中创建对应的任务类。多线程异步执行，每条定时任务之间相对独立，互不干扰
#### 此处分情况处理：
> 我这里做了定时任务的两种设置模式，自己看需求取舍

- 1.用@Async注解声明类，单独开辟新的线程异步处理。采用@Scheduled(cron = "0 0/5 * * * ?")来设置定时，注入核心业务core的bean，在@Scheduled声明的方法中调用业务方法，相对简单易读。但是corn表达式不可在web层动态的变更，必须手动来更改代码层，然后重启应用；

- 2.实现SchedulingConfigurer接口，重写configureTasks（）方法，然后在里面调用addTriggerTask（）方法，分别填入任务线程和触发器，
- 这里的任务是单独开辟线程来执行，无需注解声明异步，触发器中来获取数据表中的corn，可以在页面修改变更，动态的注入定时规则。
> 但是，修改定时规则后，不会立刻触发新的定时规则，它只能在旧规则触发时，然后新的规则生效，eg:假如把凌晨1点的任务改为凌晨2点，改动后的第一次触发，只有到了凌晨1点时，才会激活新的规则

- #####6.在wangjc-task-web-timer模块的web.hand下的TaskHandController新增方法，（如果新增的任务允许被手动触发的话，不允许就不用添加），根据任务有无参数的设定来新增数据接口


## 3.页面部分截图
![任务管理的部分截图](http://www.wangjc.vip/group1/M00/00/00/rBAAD18YBVCAULMHAAIMbxUgxas580.png "任务管理的部分截图")

- 完整的项目信息请查看具体项目，烦请点个star哦！
